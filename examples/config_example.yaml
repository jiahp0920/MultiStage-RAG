# ============================================
# MultiStage-RAG é…ç½®ç¤ºä¾‹æ–‡ä»¶
# åŒ…å«è¯¦ç»†æ³¨é‡Šå’Œç¤ºä¾‹é…ç½®
# ============================================

# ============================================
# ğŸš€ å¿«é€Ÿå¼€å§‹é…ç½®ç¤ºä¾‹
# ============================================

# 1. ä½¿ç”¨æœ€å°åŒ–é…ç½®ï¼ˆä»…éœ€é…ç½®APIå¯†é’¥ï¼‰
app:
  name: "MultiStage-RAG"
  log_level: "INFO"

retrieval:
  enabled_stages:
    recall: true
    pre_rank: true
    re_rank: true

  stage_params:
    recall:
      top_k: 100
    pre_rank:
      top_k: 20
    re_rank:
      top_k: 5
      cache_ttl: 3600

# å¿…éœ€ï¼šé…ç½®æ‚¨çš„APIå¯†é’¥
vector_store:
  type: "chroma"
  chroma:
    persist_directory: "./data/chroma_db"

reranker:
  type: "bailian"
  bailian:
    api_key: "${BAILIAN_API_KEY}"  # è®¾ç½®ç¯å¢ƒå˜é‡ BAILIAN_API_KEY

cache:
  type: "memory"  # å¼€å‘ç¯å¢ƒå¯ä½¿ç”¨å†…å­˜ç¼“å­˜
  memory:
    max_size: 1000

# ============================================
# ğŸ¯ åœºæ™¯åŒ–é…ç½®ç¤ºä¾‹
# ============================================

# åœºæ™¯1ï¼šé«˜æ€§èƒ½ç”Ÿäº§ç¯å¢ƒé…ç½®
high_performance:
  app:
    log_level: "WARNING"  # å‡å°‘æ—¥å¿—è¾“å‡º
    environment: "production"

  retrieval:
    stage_params:
      recall:
        top_k: 150  # å¬å›æ›´å¤šæ–‡æ¡£æé«˜å¬å›ç‡
      pre_rank:
        top_k: 30   # ç²—æ’è¿‡æ»¤æ›´ä¸¥æ ¼
      re_rank:
        top_k: 10   # è¿”å›æ›´å¤šæ–‡æ¡£ç»™LLM

  cache:
    type: "redis"
    redis:
      host: "redis-cluster.example.com"
      key_prefix: "prod_rag:"

  fallback:
    circuit_breaker:
      failure_threshold: 3  # ç”Ÿäº§ç¯å¢ƒæ›´æ•æ„Ÿ

# åœºæ™¯2ï¼šä¸­æ–‡æ–‡æ¡£æ£€ç´¢ä¼˜åŒ–
chinese_optimized:
  retrieval:
    stage_params:
      recall:
        embedding_model: "text-embedding-v2"  # ä¸­æ–‡ä¼˜åŒ–æ¨¡å‹

      pre_rank:
        bm25_weight: 0.6
        rule_weight: 0.4  # æé«˜è§„åˆ™æƒé‡

  rule_engine:
    rule_params:
      keyword:
        # ä¸­æ–‡åœç”¨è¯é…ç½®
        penalty_keywords:
          - "æœ¬æ–‡"
          - "ç»¼ä¸Šæ‰€è¿°"
          - "æ€»è€Œè¨€ä¹‹"

      recency:
        date_field: "å‘å¸ƒæ—¶é—´"  # ä¸­æ–‡æ—¥æœŸå­—æ®µ

  reranker:
    type: "bailian"  # é˜¿é‡Œç™¾ç‚¼å¯¹ä¸­æ–‡ä¼˜åŒ–æ›´å¥½
    bailian:
      model: "bailian-rerank-v1-chinese"

# åœºæ™¯3ï¼šç ”ç©¶å®éªŒé…ç½®
research_experiment:
  app:
    log_level: "DEBUG"  # è¯¦ç»†æ—¥å¿—ç”¨äºè°ƒè¯•
    debug: true

  retrieval:
    enabled_stages:
      recall: true
      pre_rank: true
      re_rank: false  # ç¦ç”¨ç²¾æ’ï¼Œæµ‹è¯•å‰ä¸¤é˜¶æ®µæ•ˆæœ

  rule_engine:
    enabled_rules:
      - "recency"
      - "authority"
      # - "keyword"  # æ³¨é‡Šæ‰å…³é”®è¯è§„åˆ™è¿›è¡Œå¯¹æ¯”å®éªŒ

  monitoring:
    enabled: true
    metrics:
      - "retrieval_latency"
      - "stage_latency"
      - "cache_hit_rate"

# ============================================
# ğŸ”§ ç»„ä»¶é…ç½®ç¤ºä¾‹
# ============================================

# å‘é‡å­˜å‚¨é…ç½®ç¤ºä¾‹
vector_store_examples:
  # ChromaDBï¼ˆæ¨èç”¨äºå¼€å‘å’Œä¸­å°è§„æ¨¡ï¼‰
  chroma_example:
    type: "chroma"
    chroma:
      persist_directory: "./data/chroma_db"
      collection_name: "research_papers"
      embedding_function: "sentence_transformers"
      embedding_model: "all-MiniLM-L6-v2"

  # FAISSï¼ˆæ¨èç”¨äºå¤§è§„æ¨¡æœ¬åœ°éƒ¨ç½²ï¼‰
  faiss_example:
    type: "faiss"
    faiss:
      index_path: "./data/faiss_index"
      dimension: 768
      metric_type: "L2"
      nlist: 256  # æ›´å¤§çš„nlistæé«˜ç²¾åº¦ï¼Œä½†é™ä½é€Ÿåº¦

  # Milvusï¼ˆæ¨èç”¨äºä¼ä¸šçº§éƒ¨ç½²ï¼‰
  milvus_example:
    type: "milvus"
    milvus:
      host: "milvus-cluster.example.com"
      port: 19530
      collection_name: "enterprise_docs"
      index_params:
        index_type: "HNSW"  # HNSWç´¢å¼•å¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦
        metric_type: "IP"
        params:
          M: 16
          efConstruction: 200

  # Pineconeï¼ˆæ¨èç”¨äºäº‘åŸç”Ÿéƒ¨ç½²ï¼‰
  pinecone_example:
    type: "pinecone"
    pinecone:
      api_key: "${PINECONE_API_KEY}"
      environment: "us-west1-gcp"
      index_name: "cloud-docs"
      dimension: 1536
      pod_type: "p1.x1"  # é€‰æ‹©é€‚åˆçš„podç±»å‹

# é‡æ’åºå™¨é…ç½®ç¤ºä¾‹
reranker_examples:
  # é˜¿é‡Œç™¾ç‚¼ï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼Œæ¨èç”¨äºä¸­æ–‡åœºæ™¯ï¼‰
  bailian_example:
    type: "bailian"
    bailian:
      model: "bailian-rerank-v1"
      # é«˜çº§å‚æ•°
      temperature: 0.01  # é™ä½éšæœºæ€§
      return_scores: true

  # BGEå¼€æºæ¨¡å‹ï¼ˆå…è´¹ï¼Œå¯æœ¬åœ°éƒ¨ç½²ï¼‰
  bge_example:
    type: "bge"
    bge:
      model_name: "BAAI/bge-reranker-v2-m3"
      device: "cuda"  # ä½¿ç”¨GPUåŠ é€Ÿ
      batch_size: 64   # å¢å¤§æ‰¹å¤„ç†æé«˜åå
      normalize: true  # åˆ†æ•°å½’ä¸€åŒ–

  # Cohereï¼ˆè‹±æ–‡ä¼˜åŒ–ï¼‰
  cohere_example:
    type: "cohere"
    cohere:
      model: "rerank-english-v3.0"
      top_n: 100

  # å¤šæ¨¡å‹æ··åˆï¼ˆé«˜çº§ç”¨æ³•ï¼‰
  hybrid_example:
    type: "ensemble"  # éœ€è¦è‡ªå®šä¹‰å®ç°
    weights:
      bailian: 0.5
      bge: 0.3
      cohere: 0.2

# è§„åˆ™å¼•æ“é…ç½®ç¤ºä¾‹
rule_engine_examples:
  # æ–°é—»æ—¶æ•ˆæ€§åœºæ™¯
  news_scenario:
    enabled_rules:
      - "recency"
      - "authority"
      - "keyword"

    rule_params:
      recency:
        weight: 0.4  # æ–°é—»æ—¶æ•ˆæ€§å¾ˆé‡è¦
        recent_days: 3  # 3å¤©å†…ä¸ºæœ€æ–°
        older_penalty: 0.3  # æ—§æ–°é—»ä¸¥é‡æƒ©ç½š

      authority:
        source_weights:
          official_news: 1.0
          press_release: 0.9
          verified_blog: 0.7
          social_media: 0.3

      keyword:
        mandatory_keywords: ["å‘å¸ƒä¼š", "æœ€æ–°æ¶ˆæ¯"]
        boost_keywords: ["çªå‘", "ç´§æ€¥", "é‡è¦"]

  # å­¦æœ¯è®ºæ–‡æ£€ç´¢åœºæ™¯
  academic_scenario:
    enabled_rules:
      - "authority"
      - "recency"
      - "length"

    rule_params:
      authority:
        weight: 0.6  # æƒå¨æ€§æœ€é‡è¦
        source_weights:
          nature_science: 1.0
          peer_reviewed: 0.9
          conference: 0.8
          preprint: 0.5
        citation_boost: 0.8  # é«˜å¼•ç”¨è®ºæ–‡åŠ åˆ†

      recency:
        weight: 0.3
        recent_days: 365  # 1å¹´å†…ä¸ºæ–°è®ºæ–‡

      length:
        ideal_min_length: 2000  # è®ºæ–‡é€šå¸¸è¾ƒé•¿
        ideal_max_length: 20000

  # ç”µå•†äº§å“æ£€ç´¢åœºæ™¯
  ecommerce_scenario:
    enabled_rules:
      - "keyword"
      - "authority"

    rule_params:
      keyword:
        weight: 0.7
        mandatory_keywords: []  # æ— å¿…é¡»å…³é”®è¯
        boost_keywords: ["çƒ­é”€", "æ–°å“", "æ¨è", "çˆ†æ¬¾"]
        penalty_keywords: ["ç¼ºè´§", "ä¸‹æ¶", "åœäº§"]
        keyword_weights:
          ä¼˜æƒ åˆ¸: 0.5
          æŠ˜æ‰£: 0.5
          åŒ…é‚®: 0.3

      authority:
        source_weights:
          brand_official: 1.0
          verified_seller: 0.9
          user_review: 0.6

# ============================================
# ğŸ›¡ï¸ ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
# ============================================
security_config:
  # APIå¯†é’¥ç®¡ç†
  api_keys:
    # ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸è¦ç¡¬ç¼–ç 
    # æ­£ç¡®ï¼šapi_key: "${API_KEY}"
    # é”™è¯¯ï¼šapi_key: "sk-123456789"

    # å¯†é’¥è½®æ¢ç­–ç•¥
    rotation_days: 90
    max_keys: 3

  # ç½‘ç»œå’Œè®¿é—®æ§åˆ¶
  network:
    allowed_ips:
      - "10.0.0.0/8"     # å†…éƒ¨ç½‘ç»œ
      - "192.168.0.0/16" # å†…ç½‘
    rate_limit:          # é™æµé…ç½®
      enabled: true
      requests_per_minute: 100
      burst_size: 20

  # æ•°æ®ä¿æŠ¤
  data_protection:
    encrypt_sensitive_data: true
    log_redaction: true    # æ—¥å¿—è„±æ•
    audit_logging: true    # å®¡è®¡æ—¥å¿—

# ============================================
# ğŸ“Š ç›‘æ§å’Œå‘Šè­¦é…ç½®
# ============================================
monitoring_config:
  # PrometheusæŒ‡æ ‡
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"

  # å¥åº·æ£€æŸ¥ç«¯ç‚¹
  health_check:
    endpoint: "/health"
    interval: 30
    timeout: 5

  # æ€§èƒ½é˜ˆå€¼å‘Šè­¦
  alerts:
    - metric: "retrieval_latency_p99"
      threshold: 1000  # 1ç§’
      severity: "warning"

    - metric: "cache_hit_rate"
      threshold: 0.3   # 30%
      severity: "critical"
      operator: "lt"   # å°äºé˜ˆå€¼è§¦å‘

    - metric: "error_rate"
      threshold: 0.05  # 5%
      severity: "critical"

  # æ—¥å¿—èšåˆ
  logging:
    format: "json"
    level: "INFO"
    output:
      - file: "./logs/app.log"
      - stdout: true
    sentry:
      enabled: true
      dsn: "${SENTRY_DSN}"

# ============================================
# ğŸš¨ æ•…éšœæ’é™¤å’Œè°ƒè¯•é…ç½®
# ============================================
debug_config:
  # è°ƒè¯•æ¨¡å¼
  debug_mode:
    enabled: false  # ç”Ÿäº§ç¯å¢ƒä¿æŒfalse
    log_level: "DEBUG"
    trace_requests: true
    profile_performance: false

  # è¯·æ±‚è¿½è¸ª
  request_tracing:
    enabled: true
    header: "X-Request-ID"
    include_body: false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®false

  # æ…¢æŸ¥è¯¢æ—¥å¿—
  slow_query:
    enabled: true
    threshold_ms: 500
    log_details: true

  # å†…å­˜åˆ†æ
  memory_profiling:
    enabled: false
    interval: 60
    dump_on_error: true

# ============================================
# ğŸ”„ åŠ¨æ€é…ç½®ç¤ºä¾‹
# ============================================
dynamic_config:
  # åŸºäºæ—¶é—´çš„é…ç½®
  time_based:
    business_hours:  # å·¥ä½œæ—¶é—´é…ç½®
      start: "09:00"
      end: "18:00"
      config:
        cache_ttl: 1800  # 30åˆ†é’Ÿ
        rate_limit: 200  # æ›´é«˜é™æµ

    off_hours:  # éå·¥ä½œæ—¶é—´é…ç½®
      config:
        cache_ttl: 7200  # 2å°æ—¶
        rate_limit: 50   # æ›´ä½é™æµ

  # åŸºäºè´Ÿè½½çš„é…ç½®
  load_based:
    low_load:  # ä½è´Ÿè½½
      threshold: 0.3
      config:
        pre_rank_top_k: 30
        re_rank_top_k: 10

    high_load:  # é«˜è´Ÿè½½
      threshold: 0.8
      config:
        pre_rank_top_k: 20
        re_rank_top_k: 5
        disable_rules: ["length"]  # ç¦ç”¨è®¡ç®—å¯†é›†å‹è§„åˆ™

  # A/Bæµ‹è¯•é…ç½®
  ab_testing:
    enabled: true
    experiments:
      - name: "bm25_weight_experiment"
        groups:
          control:
            weight: 0.7
            traffic: 0.5
          variant:
            weight: 0.8
            traffic: 0.5
        metric: "ndcg@5"  # è¯„ä¼°æŒ‡æ ‡

# ============================================
# ğŸ’¡ æœ€ä½³å®è·µæç¤º
# ============================================
best_practices:
  # é…ç½®ç®¡ç†
  - "ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆAPIå¯†é’¥ã€å¯†ç ç­‰ï¼‰"
  - "ä¸ºä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä½¿ç”¨ä¸åŒé…ç½®æ–‡ä»¶"
  - "å®šæœŸå®¡æŸ¥å’Œæ›´æ–°é…ç½®ï¼Œåˆ é™¤ä¸å†ä½¿ç”¨çš„é…ç½®é¡¹"

  # æ€§èƒ½ä¼˜åŒ–
  - "æ ¹æ®æ•°æ®è§„æ¨¡é€‰æ‹©åˆé€‚çš„å‘é‡å­˜å‚¨"
  - "ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼Œè°ƒæ•´ç¼“å­˜ç­–ç•¥"
  - "æ‰¹é‡å¤„ç†æ–‡æ¡£ä»¥æé«˜ååé‡"

  # å¯ç»´æŠ¤æ€§
  - "ä¸ºé…ç½®é¡¹æ·»åŠ æ³¨é‡Šè¯´æ˜ç”¨é€”"
  - "ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®æ–‡ä»¶"
  - "é…ç½®å˜æ›´æ—¶è¿›è¡Œå›å½’æµ‹è¯•"

  # å®‰å…¨æ€§
  - "ä¸è¦å°†é…ç½®æ–‡ä»¶æäº¤åˆ°å…¬å¼€ä»“åº“"
  - "å®šæœŸè½®æ¢APIå¯†é’¥"
  - "å¯ç”¨è®¿é—®æ—¥å¿—å’Œå®¡è®¡"

# ============================================
# ğŸ†˜ ç´§æ€¥æƒ…å†µå¿«é€Ÿé…ç½®
# ============================================
emergency_config:
  # æœåŠ¡é™çº§ï¼ˆå½“ä¾èµ–æœåŠ¡æ•…éšœæ—¶ï¼‰
  service_degradation:
    # ç¦ç”¨ç²¾æ’ï¼Œä¾èµ–ç²—æ’
    disable_reranker: true
    # ç¦ç”¨ç¼“å­˜ï¼Œé¿å…ç¼“å­˜æ±¡æŸ“
    disable_cache: true
    # ç®€åŒ–è§„åˆ™å¼•æ“
    minimal_rules: ["keyword"]

  # é™æµä¿æŠ¤ï¼ˆå½“æµé‡æ¿€å¢æ—¶ï¼‰
  rate_limiting:
    max_requests_per_second: 10
    queue_size: 100
    timeout: 30

  # èµ„æºé™åˆ¶ï¼ˆå½“èµ„æºä¸è¶³æ—¶ï¼‰
  resource_limits:
    max_memory_mb: 1024
    max_threads: 10
    max_connections: 50